<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>à¹à¸”à¸Šà¸šà¸­à¸£à¹Œà¸”à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸™à¹‰à¸³à¸—à¸±à¹ˆà¸§à¹‚à¸¥à¸ 2000â€“2025</title>

<!-- CDN Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>

<style>
/* ============================================================
   DESIGN SYSTEM â€” Ocean Deep Theme
   Font: Bebas Neue (display) + DM Sans (body)
   Palette: Deep navy background, cyan accents, teal highlights
   ============================================================ */
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&display=swap');

:root {
  --bg-deep:    #050d1a;
  --bg-card:    #091525;
  --bg-hover:   #0d1f38;
  --border:     rgba(0,200,255,0.10);
  --accent:     #00c8ff;
  --accent2:    #00ffc8;
  --accent3:    #7b61ff;
  --warn:       #ffd166;
  --danger:     #ff6b6b;
  --text-hi:    #e8f4fc;
  --text-mid:   #8ab4cc;
  --text-lo:    #4a6a82;
  --radius:     14px;
  --shadow:     0 8px 32px rgba(0,0,0,0.5);
  --glow:       0 0 28px rgba(0,200,255,0.15);
  --font-d:     'Bebas Neue', sans-serif;
  --font-b:     'DM Sans', sans-serif;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--font-b);
  background: var(--bg-deep);
  color: var(--text-hi);
  min-height: 100vh;
  overflow-x: hidden;
}

/* Ambient background glow */
body::before {
  content: '';
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background:
    radial-gradient(ellipse 80% 55% at 15% 0%,   rgba(0,80,160,0.28) 0%, transparent 65%),
    radial-gradient(ellipse 55% 45% at 85% 100%,  rgba(0,40,120,0.22) 0%, transparent 65%),
    radial-gradient(ellipse 35% 35% at 50% 50%,   rgba(0,200,255,0.03) 0%, transparent 70%);
}

#app { position: relative; z-index: 1; max-width: 1600px; margin: 0 auto; padding: 0 22px 64px; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   HEADER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header {
  padding: 38px 0 30px;
  display: flex; align-items: flex-end; justify-content: space-between;
  flex-wrap: wrap; gap: 16px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 28px;
}
.header-left h1 {
  font-family: var(--font-d);
  font-size: clamp(2rem, 5vw, 3.8rem);
  letter-spacing: 2px; line-height: 1;
  margin-bottom: 8px;
}
.header-left h1 span { color: var(--accent); }
.header-left p { color: var(--text-mid); font-size: 0.88rem; font-weight: 300; }
.header-right { display: flex; align-items: center; gap: 10px; }
.badge {
  background: rgba(0,200,255,0.08);
  border: 1px solid rgba(0,200,255,0.22);
  border-radius: 100px; padding: 6px 18px;
  font-size: 0.75rem; color: var(--accent);
  letter-spacing: 1px; font-weight: 600;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   UPLOAD ZONE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.upload-section {
  background: var(--bg-card);
  border: 2px dashed rgba(0,200,255,0.22);
  border-radius: var(--radius);
  padding: 22px 28px;
  display: flex; align-items: center; gap: 20px; flex-wrap: wrap;
  margin-bottom: 20px; cursor: pointer;
  transition: border-color .25s, background .25s;
}
.upload-section:hover, .upload-section.drag-over {
  border-color: var(--accent);
  background: rgba(0,200,255,0.04);
}
.upload-icon {
  width: 46px; height: 46px; flex-shrink: 0;
  background: rgba(0,200,255,0.09); border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
}
.upload-icon svg { width: 22px; height: 22px; color: var(--accent); fill: none; stroke: currentColor; stroke-width: 2; }
.upload-text h3 { font-size: 0.92rem; font-weight: 600; margin-bottom: 3px; }
.upload-text p  { font-size: 0.78rem; color: var(--text-mid); }
.btn-upload {
  margin-left: auto;
  background: linear-gradient(135deg, var(--accent) 0%, #0096c7 100%);
  color: #050d1a; border: none; border-radius: 10px;
  padding: 10px 24px; font-family: var(--font-b);
  font-weight: 700; font-size: 0.86rem; cursor: pointer;
  white-space: nowrap; transition: opacity .2s, transform .15s;
}
.btn-upload:hover { opacity: 0.85; transform: translateY(-1px); }
#file-input { display: none; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   FILTERS BAR
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.filters-bar {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px 24px;
  display: flex; flex-wrap: wrap; gap: 14px; align-items: flex-end;
  margin-bottom: 24px;
}
.filter-group { display: flex; flex-direction: column; gap: 5px; }
.filter-group label {
  font-size: 0.7rem; color: var(--text-lo);
  text-transform: uppercase; letter-spacing: 1.1px; font-weight: 600;
}
.filter-group select, .filter-group input[type="text"] {
  background: var(--bg-deep);
  border: 1px solid rgba(0,200,255,0.14);
  border-radius: 8px; color: var(--text-hi);
  padding: 8px 12px; font-family: var(--font-b); font-size: 0.86rem;
  min-width: 150px; outline: none; transition: border-color .2s;
}
.filter-group select:focus, .filter-group input:focus { border-color: var(--accent); }
.filter-group select option { background: #091525; }
.btn-reset {
  background: transparent;
  border: 1px solid rgba(255,107,107,0.3);
  color: var(--danger); border-radius: 8px;
  padding: 8px 18px; font-family: var(--font-b); font-size: 0.84rem;
  cursor: pointer; align-self: flex-end; transition: background .2s;
}
.btn-reset:hover { background: rgba(255,107,107,0.07); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SUMMARY CARDS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
  gap: 16px; margin-bottom: 24px;
}
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius); padding: 22px 22px 18px;
  position: relative; overflow: hidden;
  transition: transform .2s, box-shadow .2s;
}
.card:hover { transform: translateY(-3px); box-shadow: var(--glow); }
.card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
  border-radius: var(--radius) var(--radius) 0 0;
}
.card.c1::before { background: linear-gradient(90deg, var(--accent), #0096c7); }
.card.c2::before { background: linear-gradient(90deg, var(--accent2), #00a896); }
.card.c3::before { background: linear-gradient(90deg, var(--accent3), #5a3fd4); }
.card.c4::before { background: linear-gradient(90deg, var(--warn), #f4a261); }
.card.c5::before { background: linear-gradient(90deg, var(--danger), #e63946); }
.card-icon { font-size: 1.4rem; margin-bottom: 10px; }
.card-label {
  font-size: 0.69rem; color: var(--text-lo);
  text-transform: uppercase; letter-spacing: 1.1px;
  font-weight: 600; margin-bottom: 8px;
}
.card-value {
  font-family: var(--font-d); font-size: 2.1rem;
  letter-spacing: 1px; line-height: 1; margin-bottom: 5px;
}
.card-sub { font-size: 0.75rem; color: var(--text-mid); line-height: 1.4; }
.card.c1 .card-value { color: var(--accent); }
.card.c2 .card-value { color: var(--accent2); }
.card.c3 .card-value { color: var(--accent3); }
.card.c4 .card-value { color: var(--warn); }
.card.c5 .card-value { color: var(--danger); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CHARTS GRID
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.charts-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px; margin-bottom: 24px;
}
.chart-wide  { grid-column: 1 / -1; }
.chart-box {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius); padding: 22px 24px 24px;
}
.chart-box h3 {
  font-size: 0.76rem; color: var(--text-lo);
  text-transform: uppercase; letter-spacing: 1.2px; font-weight: 600;
  margin-bottom: 18px; display: flex; align-items: center; gap: 8px;
}
.chart-box h3 .dot {
  width: 8px; height: 8px; border-radius: 50%; display: inline-block; flex-shrink: 0;
}
.chart-container { position: relative; width: 100%; }

@media (max-width: 900px) {
  .charts-grid { grid-template-columns: 1fr; }
  .chart-wide  { grid-column: 1; }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   DATA TABLE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-section {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius); padding: 22px 24px;
}
.table-header {
  display: flex; align-items: center; justify-content: space-between;
  flex-wrap: wrap; gap: 12px; margin-bottom: 18px;
}
.table-header h3 {
  font-size: 0.76rem; color: var(--text-lo);
  text-transform: uppercase; letter-spacing: 1.2px; font-weight: 600;
}
.search-wrap { position: relative; }
.search-wrap input {
  background: var(--bg-deep);
  border: 1px solid rgba(0,200,255,0.14); border-radius: 8px;
  color: var(--text-hi); padding: 8px 12px 8px 34px;
  font-family: var(--font-b); font-size: 0.85rem;
  width: 210px; outline: none; transition: border-color .2s;
}
.search-wrap input:focus { border-color: var(--accent); }
.search-wrap svg {
  position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
  width: 14px; height: 14px; color: var(--text-lo);
  fill: none; stroke: currentColor; stroke-width: 2;
}
.table-wrapper { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 0.83rem; }
thead th {
  background: rgba(0,200,255,0.05); color: var(--text-lo);
  text-transform: uppercase; letter-spacing: 0.7px; font-size: 0.69rem; font-weight: 600;
  padding: 11px 13px; text-align: left; cursor: pointer; user-select: none;
  white-space: nowrap; border-bottom: 1px solid var(--border);
  transition: color .2s;
}
thead th:hover { color: var(--accent); }
thead th .si::after  { content: ' â‡…'; opacity: 0.35; font-size: 0.6rem; }
thead th.sa .si::after { content: ' â–²'; opacity: 1; color: var(--accent); }
thead th.sd .si::after { content: ' â–¼'; opacity: 1; color: var(--accent); }
tbody tr {
  border-bottom: 1px solid rgba(0,200,255,0.04);
  transition: background .12s;
}
tbody tr:hover { background: var(--bg-hover); }
tbody td { padding: 10px 13px; color: var(--text-hi); white-space: nowrap; }
tbody td:first-child { color: var(--accent); font-weight: 500; }

/* Scarcity level badge in table */
.badge-scarcity {
  display: inline-block; padding: 2px 9px;
  border-radius: 100px; font-size: 0.72rem; font-weight: 600;
}
.sc-low      { background: rgba(0,255,200,0.12); color: var(--accent2); }
.sc-moderate { background: rgba(255,209,102,0.12); color: var(--warn); }
.sc-high     { background: rgba(255,107,107,0.12); color: var(--danger); }
.sc-critical { background: rgba(255,50,50,0.18); color: #ff3333; border: 1px solid rgba(255,50,50,0.25); }

.table-footer {
  display: flex; align-items: center; justify-content: space-between;
  flex-wrap: wrap; gap: 8px; margin-top: 14px; padding-top: 14px;
  border-top: 1px solid var(--border); font-size: 0.78rem; color: var(--text-lo);
}
.pagination { display: flex; gap: 5px; }
.page-btn {
  background: var(--bg-deep); border: 1px solid var(--border);
  color: var(--text-mid); border-radius: 6px;
  padding: 5px 10px; font-size: 0.78rem; cursor: pointer;
  transition: border-color .2s, color .2s; font-family: var(--font-b);
}
.page-btn:hover, .page-btn.active { border-color: var(--accent); color: var(--accent); }
.page-btn:disabled { opacity: 0.28; cursor: default; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MISC
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.loading-overlay {
  position: fixed; inset: 0; z-index: 999;
  background: rgba(5,13,26,0.78);
  display: none; align-items: center; justify-content: center;
}
.spinner {
  width: 46px; height: 46px;
  border: 3px solid rgba(0,200,255,0.18);
  border-top-color: var(--accent);
  border-radius: 50%; animation: spin .75s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.no-data { text-align: center; padding: 40px; color: var(--text-lo); font-size: 0.9rem; }

@media (max-width: 640px) {
  header { padding: 22px 0 18px; }
  .upload-section { padding: 16px; }
  .btn-upload { margin-left: 0; width: 100%; text-align: center; }
  .cards-grid { grid-template-columns: 1fr 1fr; }
  .search-wrap input { width: 160px; }
}

/* Custom scrollbar */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: var(--bg-deep); }
::-webkit-scrollbar-thumb { background: rgba(0,200,255,0.18); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(0,200,255,0.35); }
</style>
</head>
<body>

<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
</div>

<div id="app">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <header>
    <div class="header-left">
      <h1>à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸™à¹‰à¸³ <span>à¸—à¸±à¹ˆà¸§à¹‚à¸¥à¸</span></h1>
      <p>à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸™à¹‰à¸³à¸—à¸±à¹ˆà¸§à¹‚à¸¥à¸ à¸›à¸µ 2000â€“2025 &nbsp;Â·&nbsp; 150 à¸›à¸£à¸°à¹€à¸—à¸¨ &nbsp;Â·&nbsp; à¹à¸”à¸Šà¸šà¸­à¸£à¹Œà¸”à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸Šà¸´à¸‡à¹‚à¸•à¹‰à¸•à¸­à¸š</p>
    </div>
    <div class="header-right">
      <span class="badge">ğŸ’§ à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸™à¹‰à¸³à¹‚à¸¥à¸</span>
      <span class="badge" id="data-source-badge" style="border-color:rgba(255,209,102,0.22);color:var(--warn);background:rgba(255,209,102,0.08)">â³ à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...</span>
    </div>
  </header>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• UPLOAD CSV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="upload-section" id="upload-zone">
    <div class="upload-icon">
      <svg viewBox="0 0 24 24"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>
    </div>
    <div class="upload-text">
      <h3>à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹„à¸Ÿà¸¥à¹Œ CSV à¸‚à¸­à¸‡à¸„à¸¸à¸“</h3>
      <p>à¸¥à¸²à¸à¸§à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¸™à¸µà¹ˆ à¸«à¸£à¸·à¸­à¸„à¸¥à¸´à¸à¹€à¸à¸·à¹ˆà¸­à¹€à¸¥à¸·à¸­à¸à¹„à¸Ÿà¸¥à¹Œ Â· à¸£à¸­à¸‡à¸£à¸±à¸š .csv à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™</p>
    </div>
    <button class="btn-upload" id="btn-upload-trigger">ğŸ“‚ à¹€à¸¥à¸·à¸­à¸à¹„à¸Ÿà¸¥à¹Œ CSV</button>
    <input type="file" id="file-input" accept=".csv">
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FILTERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="filters-bar">
    <div class="filter-group">
      <label>à¸›à¸£à¸°à¹€à¸—à¸¨</label>
      <select id="f-country"><option value="">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</option></select>
    </div>
    <div class="filter-group">
      <label>à¸›à¸µà¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™</label>
      <select id="f-year-from"><option value="">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</option></select>
    </div>
    <div class="filter-group">
      <label>à¸›à¸µà¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”</label>
      <select id="f-year-to"><option value="">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</option></select>
    </div>
    <div class="filter-group">
      <label>à¸£à¸°à¸”à¸±à¸šà¸à¸²à¸£à¸‚à¸²à¸”à¹à¸„à¸¥à¸™à¸™à¹‰à¸³</label>
      <select id="f-scarcity"><option value="">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</option></select>
    </div>
    <div class="filter-group">
      <label>à¸„à¹‰à¸™à¸«à¸²</label>
      <input type="text" id="f-search" placeholder="à¸à¸´à¸¡à¸à¹Œà¸Šà¸·à¹ˆà¸­à¸›à¸£à¸°à¹€à¸—à¸¨...">
    </div>
    <button class="btn-reset" id="btn-reset">âœ• à¸£à¸µà¹€à¸‹à¹‡à¸•</button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SUMMARY CARDS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="cards-grid">
    <div class="card c1">
      <div class="card-icon">ğŸ“Š</div>
      <div class="card-label">à¸ˆà¸³à¸™à¸§à¸™à¸£à¸²à¸¢à¸à¸²à¸£</div>
      <div class="card-value" id="s-total">â€”</div>
      <div class="card-sub" id="s-total-sub">à¸£à¸²à¸¢à¸à¸²à¸£à¸‚à¹‰à¸­à¸¡à¸¹à¸¥</div>
    </div>
    <div class="card c2">
      <div class="card-icon">ğŸ’§</div>
      <div class="card-label">à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸™à¹‰à¸³à¹€à¸‰à¸¥à¸µà¹ˆà¸¢ (à¸à¸±à¸™à¸¥à¹‰à¸²à¸™ à¸¥à¸š.à¸¡.)</div>
      <div class="card-value" id="s-avg-cons">â€”</div>
      <div class="card-sub" id="s-avg-cons-sub">à¹€à¸‰à¸¥à¸µà¹ˆà¸¢à¸•à¹ˆà¸­à¸£à¸²à¸¢à¸à¸²à¸£</div>
    </div>
    <div class="card c3">
      <div class="card-icon">ğŸš¿</div>
      <div class="card-label">à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸™à¹‰à¸³à¸•à¹ˆà¸­à¸«à¸±à¸§à¹€à¸‰à¸¥à¸µà¹ˆà¸¢ (à¸¥à¸´à¸•à¸£/à¸§à¸±à¸™)</div>
      <div class="card-value" id="s-avg-pc">â€”</div>
      <div class="card-sub" id="s-avg-pc-sub">à¹€à¸‰à¸¥à¸µà¹ˆà¸¢à¸•à¹ˆà¸­à¸„à¸™à¸•à¹ˆà¸­à¸§à¸±à¸™</div>
    </div>
    <div class="card c4">
      <div class="card-icon">ğŸŒ¾</div>
      <div class="card-label">à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸™à¹‰à¸³à¹€à¸à¸·à¹ˆà¸­à¹€à¸à¸©à¸•à¸£à¹€à¸‰à¸¥à¸µà¹ˆà¸¢ (%)</div>
      <div class="card-value" id="s-agri">â€”</div>
      <div class="card-sub" id="s-agri-sub">% à¸ à¸²à¸„à¹€à¸à¸©à¸•à¸£à¸à¸£à¸£à¸¡</div>
    </div>
    <div class="card c5">
      <div class="card-icon">âš ï¸</div>
      <div class="card-label">à¸£à¸°à¸”à¸±à¸šà¸§à¸´à¸à¸¤à¸•à¸à¸²à¸£à¸“à¹Œà¸™à¹‰à¸³</div>
      <div class="card-value" id="s-critical">â€”</div>
      <div class="card-sub" id="s-critical-sub">à¸£à¸²à¸¢à¸à¸²à¸£à¸£à¸°à¸”à¸±à¸šà¸§à¸´à¸à¸¤à¸•</div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHARTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="charts-grid">

    <!-- 1. Line â€” à¹à¸™à¸§à¹‚à¸™à¹‰à¸¡à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸™à¹‰à¸³à¸£à¸²à¸¢à¸›à¸µ (wide) -->
    <div class="chart-box chart-wide">
      <h3>
        <span class="dot" style="background:var(--accent)"></span>
        à¹à¸™à¸§à¹‚à¸™à¹‰à¸¡à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸™à¹‰à¸³à¸£à¸§à¸¡à¸£à¸²à¸¢à¸›à¸µ (à¸à¸±à¸™à¸¥à¹‰à¸²à¸™ à¸¥à¸š.à¸¡.) â€” à¸—à¸¸à¸à¸›à¸£à¸°à¹€à¸—à¸¨à¸—à¸µà¹ˆà¸à¸£à¸­à¸‡à¸­à¸¢à¸¹à¹ˆ
      </h3>
      <div class="chart-container" style="height:270px">
        <canvas id="ch-trend"></canvas>
      </div>
    </div>

    <!-- 2. Horizontal Bar â€” Top 10 à¸›à¸£à¸°à¹€à¸—à¸¨ -->
    <div class="chart-box">
      <h3>
        <span class="dot" style="background:var(--accent2)"></span>
        10 à¸­à¸±à¸™à¸”à¸±à¸šà¸›à¸£à¸°à¹€à¸—à¸¨à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸™à¹‰à¸³à¸£à¸§à¸¡à¸ªà¸¹à¸‡à¸ªà¸¸à¸” (à¸à¸±à¸™à¸¥à¹‰à¸²à¸™ à¸¥à¸š.à¸¡.)
      </h3>
      <div class="chart-container" style="height:320px">
        <canvas id="ch-top10"></canvas>
      </div>
    </div>

    <!-- 3. Donut â€” Water Scarcity Level -->
    <div class="chart-box">
      <h3>
        <span class="dot" style="background:var(--accent3)"></span>
        à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸£à¸°à¸”à¸±à¸šà¸à¸²à¸£à¸‚à¸²à¸”à¹à¸„à¸¥à¸™à¸™à¹‰à¸³ (%)
      </h3>
      <div class="chart-container" style="height:320px">
        <canvas id="ch-scarcity"></canvas>
      </div>
    </div>

    <!-- 4. Bar â€” Sector breakdown -->
    <div class="chart-box">
      <h3>
        <span class="dot" style="background:var(--warn)"></span>
        à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸™à¹‰à¸³à¸•à¸²à¸¡à¸ à¸²à¸„à¸ªà¹ˆà¸§à¸™à¹€à¸‰à¸¥à¸µà¹ˆà¸¢ (%)
      </h3>
      <div class="chart-container" style="height:270px">
        <canvas id="ch-sector"></canvas>
      </div>
    </div>

    <!-- 5. Line â€” Groundwater Depletion Trend -->
    <div class="chart-box">
      <h3>
        <span class="dot" style="background:var(--danger)"></span>
        à¹à¸™à¸§à¹‚à¸™à¹‰à¸¡à¸­à¸±à¸•à¸£à¸²à¸à¸²à¸£à¸¥à¸”à¸¥à¸‡à¸‚à¸­à¸‡à¸™à¹‰à¸³à¹ƒà¸•à¹‰à¸”à¸´à¸™ (%) à¹€à¸‰à¸¥à¸µà¹ˆà¸¢à¸£à¸²à¸¢à¸›à¸µ
      </h3>
      <div class="chart-container" style="height:270px">
        <canvas id="ch-gw"></canvas>
      </div>
    </div>

  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DATA TABLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="table-section">
    <div class="table-header">
      <h3>ğŸ“‹ à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</h3>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <span id="t-count" style="font-size:0.78rem;color:var(--text-lo)"></span>
        <div class="search-wrap">
          <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" id="t-search" placeholder="à¸„à¹‰à¸™à¸«à¸²à¹ƒà¸™à¸•à¸²à¸£à¸²à¸‡...">
        </div>
      </div>
    </div>
    <div class="table-wrapper">
      <table>
        <thead id="t-head"></thead>
        <tbody id="t-body"></tbody>
      </table>
      <div class="no-data" id="t-nodata" style="display:none">à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸•à¸£à¸‡à¸à¸±à¸šà¸à¸²à¸£à¸„à¹‰à¸™à¸«à¸²</div>
    </div>
    <div class="table-footer">
      <span id="t-info">â€”</span>
      <div class="pagination" id="t-pag"></div>
    </div>
  </div>

</div><!-- /#app -->

<script>
/* ============================================================
   à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸à¹„à¸Ÿà¸¥à¹Œ CSV à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œà¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸™
   ============================================================ */
const CSV_FILE = 'global_water_consumption_2000_2025.csv';

/* ============================================================
   GLOBAL STATE
   ============================================================ */
let allData      = [];   // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸—à¸µà¹ˆà¹‚à¸«à¸¥à¸”à¸ˆà¸²à¸ CSV
let filteredData = [];   // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸«à¸¥à¸±à¸‡ filter
let columns      = [];   // à¸Šà¸·à¹ˆà¸­ columns à¸ˆà¸²à¸ CSV
let charts       = {};   // à¹€à¸à¹‡à¸š Chart.js instances à¹€à¸à¸·à¹ˆà¸­ destroy à¸à¹ˆà¸­à¸™ re-render
let sortState    = { col: null, dir: 'asc' };
let currentPage  = 1;
const PAGE_SIZE  = 15;

// à¹à¸›à¸¥à¸Šà¸·à¹ˆà¸­ column à¸ˆà¸²à¸à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸© (à¹ƒà¸™ CSV) â†’ à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ à¸ªà¸³à¸«à¸£à¸±à¸šà¹à¸ªà¸”à¸‡à¹ƒà¸™ header à¸•à¸²à¸£à¸²à¸‡
const COL_TH = {
  'Country'                             : 'à¸›à¸£à¸°à¹€à¸—à¸¨',
  'Year'                                : 'à¸›à¸µ',
  'Total Water Consumption (Billion m3)': 'à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸™à¹‰à¸³à¸£à¸§à¸¡ (à¸à¸±à¸™à¸¥à¹‰à¸²à¸™ à¸¥à¸š.à¸¡.)',
  'Per Capita Water Use (L/Day)'        : 'à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸™à¹‰à¸³à¸•à¹ˆà¸­à¸«à¸±à¸§ (à¸¥à¸´à¸•à¸£/à¸§à¸±à¸™)',
  'Agricultural Water Use (%)'          : 'à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸™à¹‰à¸³à¹€à¸à¸©à¸•à¸£ (%)',
  'Industrial Water Use (%)'            : 'à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸™à¹‰à¸³à¸­à¸¸à¸•à¸ªà¸²à¸«à¸à¸£à¸£à¸¡ (%)',
  'Household Water Use (%)'             : 'à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸™à¹‰à¸³à¸„à¸£à¸±à¸§à¹€à¸£à¸·à¸­à¸™ (%)',
  'Rainfall Impact (mm)'                : 'à¸›à¸£à¸´à¸¡à¸²à¸“à¸™à¹‰à¸³à¸à¸™ (à¸¡à¸¡.)',
  'Groundwater Depletion Rate (%)'      : 'à¸­à¸±à¸•à¸£à¸²à¸¥à¸”à¸™à¹‰à¸³à¹ƒà¸•à¹‰à¸”à¸´à¸™ (%)',
  'Water Scarcity Level'                : 'à¸£à¸°à¸”à¸±à¸šà¸à¸²à¸£à¸‚à¸²à¸”à¹à¸„à¸¥à¸™à¸™à¹‰à¸³',
};

// Column keys à¸•à¸£à¸‡à¸à¸±à¸šà¸Šà¸·à¹ˆà¸­ header à¹ƒà¸™ CSV à¸ˆà¸£à¸´à¸‡
const COL = {
  COUNTRY  : 'Country',
  YEAR     : 'Year',
  CONS     : 'Total Water Consumption (Billion m3)',
  PC       : 'Per Capita Water Use (L/Day)',
  AGRI     : 'Agricultural Water Use (%)',
  INDUS    : 'Industrial Water Use (%)',
  HOUSE    : 'Household Water Use (%)',
  RAIN     : 'Rainfall Impact (mm)',
  GW       : 'Groundwater Depletion Rate (%)',
  SCARCITY : 'Water Scarcity Level',
};

/* ============================================================
   INIT â€” à¸¥à¸­à¸‡ fetch CSV à¸ˆà¸²à¸à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œà¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸™à¸à¹ˆà¸­à¸™
          à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹ƒà¸«à¹‰à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹€à¸­à¸‡à¸œà¹ˆà¸²à¸™ UI
   ============================================================ */
document.addEventListener('DOMContentLoaded', () => {
  initFilters();
  initTableSearch();
  initUpload();
  document.getElementById('btn-reset').addEventListener('click', resetFilters);
  loadCSV();
});

/* ============================================================
   UPLOAD â€” à¸£à¸­à¸‡à¸£à¸±à¸š click à¹à¸¥à¸° drag & drop
   ============================================================ */
function initUpload() {
  const zone   = document.getElementById('upload-zone');
  const input  = document.getElementById('file-input');
  const btnTrg = document.getElementById('btn-upload-trigger');

  btnTrg.addEventListener('click', e => { e.stopPropagation(); input.click(); });
  zone.addEventListener('click', () => input.click());

  input.addEventListener('change', e => {
    const f = e.target.files[0];
    if (f) readFile(f);
    input.value = '';
  });

  zone.addEventListener('dragover',  e => { e.preventDefault(); zone.classList.add('drag-over'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
  zone.addEventListener('drop', e => {
    e.preventDefault(); zone.classList.remove('drag-over');
    const f = e.dataTransfer.files[0];
    if (f && f.name.endsWith('.csv')) readFile(f);
    else alert('à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¹„à¸Ÿà¸¥à¹Œ .csv à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™');
  });
}

function readFile(file) {
  document.getElementById('loading').style.display = 'flex';
  const reader = new FileReader();
  reader.onload  = e => {
    parseAndLoad(e.target.result, file.name);
    document.getElementById('loading').style.display = 'none';
  };
  reader.onerror = () => {
    alert('à¸­à¹ˆà¸²à¸™à¹„à¸Ÿà¸¥à¹Œà¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ');
    document.getElementById('loading').style.display = 'none';
  };
  reader.readAsText(file, 'UTF-8');
}

/* ============================================================
   LOAD CSV à¸œà¹ˆà¸²à¸™ fetch() â€” à¹‚à¸«à¸¥à¸”à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¹€à¸¡à¸·à¹ˆà¸­à¸­à¸¢à¸¹à¹ˆà¸šà¸™ server
   à¸–à¹‰à¸²à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§ (à¹€à¸›à¸´à¸”à¸ˆà¸²à¸ file://) â†’ à¹à¸ªà¸”à¸‡à¸„à¸³à¹à¸™à¸°à¸™à¸³à¹ƒà¸«à¹‰à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”
   ============================================================ */
function loadCSV() {
  const badge = document.getElementById('data-source-badge');
  document.getElementById('loading').style.display = 'flex';

  fetch(CSV_FILE)
    .then(res => {
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.text();
    })
    .then(csvText => {
      parseAndLoad(csvText, CSV_FILE);
      document.getElementById('loading').style.display = 'none';
    })
    .catch(() => {
      // à¹€à¸›à¸´à¸”à¸ˆà¸²à¸ file:// à¸«à¸£à¸·à¸­à¸«à¸²à¹„à¸Ÿà¸¥à¹Œà¹„à¸¡à¹ˆà¹€à¸ˆà¸­ â†’ à¹ƒà¸«à¹‰à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹€à¸­à¸‡
      document.getElementById('loading').style.display = 'none';
      badge.textContent = 'ğŸ“‚ à¸à¸£à¸¸à¸“à¸²à¸­à¸±à¸›à¹‚à¸«à¸¥à¸” CSV';
      badge.style.color       = 'var(--warn)';
      badge.style.borderColor = 'rgba(255,209,102,0.3)';
      badge.style.background  = 'rgba(255,209,102,0.08)';
    });
}

/* ============================================================
   PARSE CSV à¸”à¹‰à¸§à¸¢ PapaParse â†’ à¹€à¸à¹‡à¸šà¹ƒà¸™ allData
   ============================================================ */
function parseAndLoad(csvText, sourceName) {
  const result = Papa.parse(csvText.trim(), {
    header:          true,
    skipEmptyLines:  true,
    dynamicTyping:   true,
    transformHeader: h => h.trim(),
  });

  allData  = result.data;
  columns  = result.meta.fields || [];

  // à¸­à¸±à¸›à¹€à¸”à¸• badge
  const badge = document.getElementById('data-source-badge');
  badge.textContent = `âœ… ${allData.length.toLocaleString()} à¸£à¸²à¸¢à¸à¸²à¸£`;
  badge.style.color        = 'var(--accent2)';
  badge.style.borderColor  = 'rgba(0,255,200,0.22)';
  badge.style.background   = 'rgba(0,255,200,0.08)';

  // à¸­à¸±à¸›à¹€à¸”à¸• upload zone à¸šà¸­à¸à¸Šà¸·à¹ˆà¸­à¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¹‚à¸«à¸¥à¸”
  const uploadText = document.querySelector('.upload-text p');
  if (uploadText) uploadText.textContent = `âœ… à¹‚à¸«à¸¥à¸”à¹à¸¥à¹‰à¸§: ${sourceName} â€” ${allData.length.toLocaleString()} à¸£à¸²à¸¢à¸à¸²à¸£, ${columns.length} à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œ`;

  populateFilterOptions();
  filteredData = [...allData];
  currentPage  = 1;
  renderAll();
}

/* ============================================================
   FILTER OPTIONS â€” à¸ªà¸£à¹‰à¸²à¸‡ Dropdown à¸ˆà¸²à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸£à¸´à¸‡
   ============================================================ */
function populateFilterOptions() {
  const countries  = [...new Set(allData.map(r => r[COL.COUNTRY]))].filter(Boolean).sort();
  const years      = [...new Set(allData.map(r => r[COL.YEAR]))].filter(Boolean).sort((a,b)=>a-b);
  const scarcities = ['Low','Moderate','High','Critical']; // à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡à¸„à¸§à¸²à¸¡à¸£à¸¸à¸™à¹à¸£à¸‡

  fillSelect('f-country',   countries);
  fillSelect('f-year-from', years);
  fillSelect('f-year-to',   years);
  fillSelect('f-scarcity',  scarcities);
}

function fillSelect(id, opts) {
  const sel = document.getElementById(id);
  const cur = sel.value;
  sel.innerHTML = '<option value="">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</option>';
  opts.forEach(o => {
    const el = document.createElement('option');
    el.value = o; el.textContent = o;
    sel.appendChild(el);
  });
  sel.value = cur; // à¸„à¸·à¸™à¸„à¹ˆà¸²à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸à¸­à¸¢à¸¹à¹ˆ
}

/* ============================================================
   FILTER EVENTS
   ============================================================ */
function initFilters() {
  ['f-country','f-year-from','f-year-to','f-scarcity','f-search']
    .forEach(id => document.getElementById(id).addEventListener('change', applyFilters));
  document.getElementById('f-search').addEventListener('input', applyFilters);
}

function initTableSearch() {
  document.getElementById('t-search').addEventListener('input', () => {
    currentPage = 1; renderTable();
  });
}

function resetFilters() {
  ['f-country','f-year-from','f-year-to','f-scarcity'].forEach(id => {
    document.getElementById(id).value = '';
  });
  document.getElementById('f-search').value = '';
  document.getElementById('t-search').value = '';
  applyFilters();
}

/* â”€â”€ à¸à¸£à¸­à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸•à¸²à¸¡ filter à¸—à¸¸à¸à¸•à¸±à¸§ â”€â”€ */
function applyFilters() {
  const country  = document.getElementById('f-country').value;
  const yearFrom = +document.getElementById('f-year-from').value || 0;
  const yearTo   = +document.getElementById('f-year-to').value   || Infinity;
  const scarcity = document.getElementById('f-scarcity').value;
  const search   = document.getElementById('f-search').value.toLowerCase();

  filteredData = allData.filter(r => {
    if (country  && r[COL.COUNTRY]   !== country)                            return false;
    if (yearFrom && +r[COL.YEAR] < yearFrom)                                 return false;
    if (yearTo !== Infinity && +r[COL.YEAR] > yearTo)                        return false;
    if (scarcity && r[COL.SCARCITY]  !== scarcity)                           return false;
    if (search && !String(r[COL.COUNTRY]).toLowerCase().includes(search))    return false;
    return true;
  });

  currentPage = 1;
  renderAll();
}

/* ============================================================
   RENDER ALL â€” à¹€à¸£à¸µà¸¢à¸à¸—à¸¸à¸à¸ªà¹ˆà¸§à¸™à¸à¸£à¹‰à¸­à¸¡à¸à¸±à¸™
   ============================================================ */
function renderAll() {
  renderCards();
  renderTrend();
  renderTop10();
  renderScarcity();
  renderSector();
  renderGroundwater();
  renderTable();
}

/* ============================================================
   HELPERS
   ============================================================ */

// Format à¸•à¸±à¸§à¹€à¸¥à¸‚: 1,234.5 / 1.2K / 1.5M
function fmt(n, dec=1) {
  if (n == null || isNaN(n)) return 'â€”';
  if (Math.abs(n) >= 1e6)  return (n/1e6).toFixed(dec)+'M';
  if (Math.abs(n) >= 1e4)  return (n/1e3).toFixed(dec)+'K';
  return Number(n).toLocaleString('en-US', {maximumFractionDigits: dec});
}

// avg array
function avg(arr) { return arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0; }

// Ocean colour palette
const PAL = [
  '#00c8ff','#00ffc8','#7b61ff','#ffd166','#ff6b6b',
  '#06d6a0','#118ab2','#ef476f','#1b998b','#f4a261',
  '#264653','#2a9d8f','#e76f51','#ffc43d','#e9c46a'
];

// Scarcity level â†’ colour
const SCARCITY_COLOR = {
  Low:      { bg:'rgba(0,255,200,0.18)',  border:'#00ffc8' },
  Moderate: { bg:'rgba(255,209,102,0.18)',border:'#ffd166' },
  High:     { bg:'rgba(255,107,107,0.18)',border:'#ff6b6b' },
  Critical: { bg:'rgba(255,50,50,0.25)',  border:'#ff3333' },
};

// datalabels à¸„à¹ˆà¸² default
const DL_BASE = {
  color: '#e8f4fc',
  font: { family:"'DM Sans'", weight:'600', size:11 },
  clip: false,
};

// destroy chart à¸à¹ˆà¸­à¸™ re-create
function killChart(key) {
  if (charts[key]) { charts[key].destroy(); charts[key] = null; }
}

/* ============================================================
   1. SUMMARY CARDS
   ============================================================ */
function renderCards() {
  const d = filteredData;
  if (!d.length) return;

  const total   = d.length;
  const cons    = d.map(r => +r[COL.CONS] || 0);
  const pc      = d.map(r => +r[COL.PC]   || 0);
  const agri    = d.map(r => +r[COL.AGRI] || 0);
  const critical = d.filter(r => r[COL.SCARCITY] === 'Critical').length;

  // à¸›à¸£à¸°à¹€à¸—à¸¨à¸—à¸µà¹ˆà¸¡à¸µà¸„à¹ˆà¸² Groundwater Depletion à¹€à¸‰à¸¥à¸µà¹ˆà¸¢à¸ªà¸¹à¸‡à¸ªà¸¸à¸”
  const gwByCountry = {};
  d.forEach(r => {
    if (!gwByCountry[r[COL.COUNTRY]]) gwByCountry[r[COL.COUNTRY]] = [];
    gwByCountry[r[COL.COUNTRY]].push(+r[COL.GW]||0);
  });

  document.getElementById('s-total').textContent       = fmt(total, 0);
  document.getElementById('s-total-sub').textContent   = `à¸ˆà¸²à¸ ${new Set(d.map(r=>r[COL.COUNTRY])).size} à¸›à¸£à¸°à¹€à¸—à¸¨`;

  document.getElementById('s-avg-cons').textContent    = fmt(avg(cons));
  document.getElementById('s-avg-cons-sub').textContent= `à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” ${fmt(cons.reduce((a,b)=>a+b,0))} Bn mÂ³`;

  document.getElementById('s-avg-pc').textContent      = fmt(avg(pc), 1);
  document.getElementById('s-avg-pc-sub').textContent  = 'à¸¥à¸´à¸•à¸£/à¸„à¸™/à¸§à¸±à¸™ à¹€à¸‰à¸¥à¸µà¹ˆà¸¢';

  document.getElementById('s-agri').textContent        = fmt(avg(agri), 1)+'%';
  document.getElementById('s-agri-sub').textContent    = `à¸­à¸¸à¸•à¸ªà¸²à¸«à¸à¸£à¸£à¸¡ ${fmt(avg(d.map(r=>+r[COL.INDUS]||0)),1)}% Â· à¸„à¸£à¸±à¸§à¹€à¸£à¸·à¸­à¸™ ${fmt(avg(d.map(r=>+r[COL.HOUSE]||0)),1)}%`;

  document.getElementById('s-critical').textContent    = fmt(critical, 0);
  const critPct = total ? (critical/total*100).toFixed(1) : 0;
  document.getElementById('s-critical-sub').textContent= `${critPct}% à¸‚à¸­à¸‡à¸£à¸²à¸¢à¸à¸²à¸£à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”`;
}

/* ============================================================
   2. LINE CHART â€” à¹à¸™à¸§à¹‚à¸™à¹‰à¸¡à¸£à¸²à¸¢à¸›à¸µ
   ============================================================ */
function renderTrend() {
  killChart('trend');

  // à¸£à¸§à¸¡à¸„à¹ˆà¸² Total Consumption à¸•à¸²à¸¡à¸›à¸µ (à¸–à¹‰à¸² filter à¹€à¸¥à¸·à¸­à¸à¸›à¸£à¸°à¹€à¸—à¸¨à¹€à¸”à¸µà¸¢à¸§ â†’ à¹à¸ªà¸”à¸‡à¸›à¸£à¸°à¹€à¸—à¸¨à¸™à¸±à¹‰à¸™)
  const byYear = {};
  filteredData.forEach(r => {
    const y = r[COL.YEAR];
    byYear[y] = (byYear[y] || 0) + (+r[COL.CONS] || 0);
  });
  const years  = Object.keys(byYear).sort((a,b)=>a-b);
  const values = years.map(y => +byYear[y].toFixed(2));

  if (!years.length) return;

  const maxV = Math.max(...values);
  const minV = Math.min(...values);

  charts.trend = new Chart(document.getElementById('ch-trend'), {
    type: 'line',
    data: {
      labels: years,
      datasets: [{
        label: 'à¸à¸±à¸™à¸¥à¹‰à¸²à¸™ à¸¥à¸š.à¸¡.',
        data: values,
        borderColor: '#00c8ff',
        backgroundColor: ctx => {
          // Gradient fill
          const g = ctx.chart.ctx.createLinearGradient(0, 0, 0, ctx.chart.height);
          g.addColorStop(0, 'rgba(0,200,255,0.22)');
          g.addColorStop(1, 'rgba(0,200,255,0.01)');
          return g;
        },
        borderWidth: 2.5,
        pointBackgroundColor: values.map(v => v===maxV?'#ff6b6b':v===minV?'#00ffc8':'#00c8ff'),
        pointRadius: values.map(v => (v===maxV||v===minV) ? 6 : 3),
        pointHoverRadius: 7,
        fill: true, tension: 0.35,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: { label: ctx => ` ${fmt(ctx.raw)} à¸à¸±à¸™à¸¥à¹‰à¸²à¸™ à¸¥à¸š.à¸¡.` }
        },
        datalabels: {
          ...DL_BASE,
          align: 'top', anchor: 'end',
          formatter: (v, ctx) => {
            if (!ctx || ctx.dataIndex == null) return '';
            const i   = ctx.dataIndex;
            const len = ctx.dataset.data.length;
            return (v===maxV || v===minV || i===0 || i===len-1) ? fmt(v) : '';
          },
          color: (ctx) => {
            if (!ctx || ctx.dataIndex == null) return '#8ab4cc';
            const v = ctx.dataset.data[ctx.dataIndex];
            return v===maxV ? '#ff6b6b' : v===minV ? '#00ffc8' : '#8ab4cc';
          }
        }
      },
      scales: {
        x: {
          ticks: { color:'#4a6a82', maxRotation: 45, font:{size:10} },
          grid:  { color:'rgba(0,200,255,0.04)' }
        },
        y: {
          ticks: { color:'#4a6a82', callback: v => fmt(v), font:{size:10} },
          grid:  { color:'rgba(0,200,255,0.07)' }
        }
      },
      layout: { padding: { top: 28, right: 16 } }
    },
    plugins: [ChartDataLabels]
  });
}

/* ============================================================
   3. HORIZONTAL BAR â€” Top 10 à¸›à¸£à¸°à¹€à¸—à¸¨
   ============================================================ */
function renderTop10() {
  killChart('top10');

  // à¸£à¸§à¸¡à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸™à¹‰à¸³à¸•à¹ˆà¸­à¸›à¸£à¸°à¹€à¸—à¸¨
  const byCtry = {};
  filteredData.forEach(r => {
    byCtry[r[COL.COUNTRY]] = (byCtry[r[COL.COUNTRY]] || 0) + (+r[COL.CONS] || 0);
  });
  const sorted = Object.entries(byCtry).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const labels = sorted.map(e => e[0]);
  const values = sorted.map(e => +e[1].toFixed(2));
  const total  = values.reduce((a,b)=>a+b,0) || 1;

  charts.top10 = new Chart(document.getElementById('ch-top10'), {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'à¸à¸±à¸™à¸¥à¹‰à¸²à¸™ à¸¥à¸š.à¸¡.',
        data: values,
        backgroundColor: labels.map((_,i) => PAL[i%PAL.length]+'bb'),
        borderColor:      labels.map((_,i) => PAL[i%PAL.length]),
        borderWidth: 1.5, borderRadius: 6,
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        datalabels: {
          ...DL_BASE,
          anchor: 'end', align: 'end', clip: false,
          formatter: (v) => `${fmt(v)}  (${(v/total*100).toFixed(1)}%)`,
          color: '#8ab4cc',
        }
      },
      scales: {
        x: { ticks:{ color:'#4a6a82', callback: v=>fmt(v), font:{size:10} }, grid:{ color:'rgba(0,200,255,0.05)' } },
        y: { ticks:{ color:'#c8dce8', font:{size:11}}, grid:{ display:false } }
      },
      layout: { padding: { right: 90 } }
    },
    plugins: [ChartDataLabels]
  });
}

/* ============================================================
   4. DONUT â€” Water Scarcity Level
   ============================================================ */
function renderScarcity() {
  killChart('scarcity');

  const SCARCITY_TH = { Low:'à¸•à¹ˆà¸³', Moderate:'à¸›à¸²à¸™à¸à¸¥à¸²à¸‡', High:'à¸ªà¸¹à¸‡', Critical:'à¸§à¸´à¸à¸¤à¸•' };
  const count = { Low:0, Moderate:0, High:0, Critical:0 };
  filteredData.forEach(r => {
    const s = r[COL.SCARCITY];
    if (s in count) count[s]++;
  });

  const keys   = Object.keys(count).filter(k => count[k] > 0);
  const labels = keys.map(k => SCARCITY_TH[k] || k);
  const values = keys.map(k => count[k]);
  const total  = values.reduce((a,b)=>a+b,0) || 1;

  charts.scarcity = new Chart(document.getElementById('ch-scarcity'), {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: keys.map(k => SCARCITY_COLOR[k]?.bg   || '#ffffff22'),
        borderColor:      keys.map(k => SCARCITY_COLOR[k]?.border || '#fff'),
        borderWidth: 2,
        hoverOffset: 8,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      cutout: '60%',
      plugins: {
        legend: {
          position: 'right',
          labels: { color:'#8ab4cc', font:{size:11}, boxWidth:13, padding:12 }
        },
        tooltip: {
          callbacks: { label: ctx => ` ${ctx.label}: ${ctx.raw} à¸£à¸²à¸¢à¸à¸²à¸£ (${(ctx.raw/total*100).toFixed(1)}%)` }
        },
        datalabels: {
          ...DL_BASE,
          formatter: (v) => {
            const pct = (v/total*100).toFixed(1);
            return pct < 4 ? '' : pct+'%';
          },
          color: (ctx) => {
            if (!ctx || ctx.dataIndex == null) return '#fff';
            const key = keys[ctx.dataIndex];
            return SCARCITY_COLOR[key]?.border || '#fff';
          },
          font: { weight:'700', size:13 },
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

/* ============================================================
   5. BAR â€” Sector breakdown (Agricultural / Industrial / Household)
   ============================================================ */
function renderSector() {
  killChart('sector');

  const agriAvg  = avg(filteredData.map(r => +r[COL.AGRI]  || 0));
  const indusAvg = avg(filteredData.map(r => +r[COL.INDUS] || 0));
  const houseAvg = avg(filteredData.map(r => +r[COL.HOUSE] || 0));
  const total    = agriAvg + indusAvg + houseAvg || 1;

  const sectors = ['à¹€à¸à¸©à¸•à¸£à¸à¸£à¸£à¸¡','à¸­à¸¸à¸•à¸ªà¸²à¸«à¸à¸£à¸£à¸¡','à¸„à¸£à¸±à¸§à¹€à¸£à¸·à¸­à¸™'];
  const values  = [+agriAvg.toFixed(2), +indusAvg.toFixed(2), +houseAvg.toFixed(2)];
  const colors  = ['rgba(255,209,102,0.75)','rgba(123,97,255,0.75)','rgba(0,200,255,0.75)'];
  const borders = ['#ffd166','#7b61ff','#00c8ff'];

  charts.sector = new Chart(document.getElementById('ch-sector'), {
    type: 'bar',
    data: {
      labels: sectors,
      datasets: [{
        label: 'à¹€à¸‰à¸¥à¸µà¹ˆà¸¢ (%)',
        data: values,
        backgroundColor: colors,
        borderColor:     borders,
        borderWidth: 1.5, borderRadius: 10,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        datalabels: {
          ...DL_BASE,
          anchor: 'end', align: 'end',
          formatter: (v) => `${fmt(v,1)}%\n(${(v/total*100).toFixed(1)}% à¸‚à¸­à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”)`,
          color: (ctx) => {
            if (!ctx || ctx.dataIndex == null) return '#8ab4cc';
            return borders[ctx.dataIndex] || '#8ab4cc';
          },
          font: { size:11, weight:'700' },
        }
      },
      scales: {
        x: { ticks:{color:'#8ab4cc', font:{size:11}}, grid:{display:false} },
        y: {
          ticks:{ color:'#4a6a82', callback: v=>v+'%', font:{size:10} },
          grid: { color:'rgba(0,200,255,0.06)' },
          max: 100,
        }
      },
      layout: { padding: { top: 36 } }
    },
    plugins: [ChartDataLabels]
  });
}

/* ============================================================
   6. LINE â€” Groundwater Depletion Rate à¸£à¸²à¸¢à¸›à¸µ
   ============================================================ */
function renderGroundwater() {
  killChart('gw');

  // à¹€à¸‰à¸¥à¸µà¹ˆà¸¢ Groundwater Depletion Rate à¸•à¸²à¸¡à¸›à¸µ
  const byYear = {};
  const cntYear= {};
  filteredData.forEach(r => {
    const y = r[COL.YEAR]; const v = +r[COL.GW] || 0;
    byYear[y]  = (byYear[y]  || 0) + v;
    cntYear[y] = (cntYear[y] || 0) + 1;
  });
  const years  = Object.keys(byYear).sort((a,b)=>a-b);
  const values = years.map(y => +(byYear[y]/cntYear[y]).toFixed(3));

  if (!years.length) return;

  const maxV = Math.max(...values);

  charts.gw = new Chart(document.getElementById('ch-gw'), {
    type: 'line',
    data: {
      labels: years,
      datasets: [{
        label: 'à¸­à¸±à¸•à¸£à¸²à¸à¸²à¸£à¸¥à¸”à¸¥à¸‡à¸‚à¸­à¸‡à¸™à¹‰à¸³à¹ƒà¸•à¹‰à¸”à¸´à¸™ (%)',
        data: values,
        borderColor: '#ff6b6b',
        backgroundColor: ctx => {
          const g = ctx.chart.ctx.createLinearGradient(0,0,0,ctx.chart.height);
          g.addColorStop(0, 'rgba(255,107,107,0.20)');
          g.addColorStop(1, 'rgba(255,107,107,0.01)');
          return g;
        },
        borderWidth: 2.5,
        pointBackgroundColor: values.map(v => v===maxV ? '#ff3333':'#ff6b6b'),
        pointRadius:          values.map(v => v===maxV ? 7:3),
        pointHoverRadius: 7,
        fill: true, tension: 0.35,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: ctx => ` à¸­à¸±à¸•à¸£à¸²à¸¥à¸”à¸¥à¸‡à¸‚à¸­à¸‡à¸™à¹‰à¸³à¹ƒà¸•à¹‰à¸”à¸´à¸™: ${ctx.raw}%` } },
        datalabels: {
          ...DL_BASE,
          align: 'top', anchor: 'end',
          formatter: (v, ctx) => {
            if (!ctx || ctx.dataIndex == null) return '';
            const i   = ctx.dataIndex;
            const len = ctx.dataset.data.length;
            return (v===maxV || i===0 || i===len-1) ? v+'%' : '';
          },
          color: (ctx) => {
            if (!ctx || ctx.dataIndex == null) return '#8ab4cc';
            return ctx.dataset.data[ctx.dataIndex]===maxV ? '#ff3333':'#8ab4cc';
          },
        }
      },
      scales: {
        x: { ticks:{color:'#4a6a82', maxRotation:45, font:{size:10}}, grid:{color:'rgba(255,107,107,0.04)'} },
        y: { ticks:{color:'#4a6a82', callback: v=>v+'%', font:{size:10}}, grid:{color:'rgba(255,107,107,0.07)'} }
      },
      layout: { padding: { top: 28, right: 12 } }
    },
    plugins: [ChartDataLabels]
  });
}

/* ============================================================
   7. DATA TABLE â€” Sort + Search + Pagination
   ============================================================ */
function renderTable() {
  const thead = document.getElementById('t-head');
  const tbody = document.getElementById('t-body');
  const info  = document.getElementById('t-info');

  // à¸à¸£à¸­à¸‡à¸”à¹‰à¸§à¸¢ table search box (à¹à¸¢à¸à¸ˆà¸²à¸ filter bar)
  const q = document.getElementById('t-search').value.toLowerCase();
  let disp = q
    ? filteredData.filter(r => Object.values(r).join(' ').toLowerCase().includes(q))
    : [...filteredData];

  // Sort
  if (sortState.col) {
    disp.sort((a,b) => {
      const va = a[sortState.col], vb = b[sortState.col];
      const cmp = (typeof va==='number' && typeof vb==='number')
        ? va - vb
        : String(va||'').localeCompare(String(vb||''),'en');
      return sortState.dir==='asc' ? cmp : -cmp;
    });
  }

  // Pagination
  const total = disp.length;
  const pages = Math.ceil(total/PAGE_SIZE) || 1;
  currentPage = Math.min(currentPage, pages);
  const start = (currentPage-1)*PAGE_SIZE;
  const slice = disp.slice(start, start+PAGE_SIZE);

  document.getElementById('t-count').textContent = `${total.toLocaleString()} à¸£à¸²à¸¢à¸à¸²à¸£`;
  info.textContent = `à¹à¸ªà¸”à¸‡ ${start+1}â€“${Math.min(start+PAGE_SIZE, total)} à¸ˆà¸²à¸ ${total.toLocaleString()} à¸£à¸²à¸¢à¸à¸²à¸£`;

  // â”€â”€ Header â”€â”€
  if (!columns.length) { thead.innerHTML=''; tbody.innerHTML=''; return; }
  document.getElementById('t-nodata').style.display = total ? 'none' : 'block';

  thead.innerHTML = '<tr>' + columns.map(c => {
    const cls  = sortState.col===c ? (sortState.dir==='asc'?'sa':'sd') : '';
    const label = COL_TH[c] || c;
    return `<th class="${cls}" data-col="${c}">${label}<span class="si"></span></th>`;
  }).join('') + '</tr>';

  thead.querySelectorAll('th').forEach(th => {
    th.addEventListener('click', () => {
      const col = th.dataset.col;
      sortState.dir = sortState.col===col && sortState.dir==='asc' ? 'desc':'asc';
      sortState.col = col;
      renderTable();
    });
  });

  // â”€â”€ Body â”€â”€
  tbody.innerHTML = slice.map(row =>
    '<tr>' + columns.map(c => {
      let val = row[c] != null ? row[c] : 'â€”';
      // à¹à¸ªà¸”à¸‡ Scarcity Level à¹€à¸›à¹‡à¸™ badge
      if (c === COL.SCARCITY) {
        const thMap = {Low:'à¸•à¹ˆà¸³', Moderate:'à¸›à¸²à¸™à¸à¸¥à¸²à¸‡', High:'à¸ªà¸¹à¸‡', Critical:'à¸§à¸´à¸à¸¤à¸•'};
        const cls = {Low:'sc-low',Moderate:'sc-moderate',High:'sc-high',Critical:'sc-critical'}[val] || '';
        val = `<span class="badge-scarcity ${cls}">${thMap[val] || val}</span>`;
      }
      return `<td>${val}</td>`;
    }).join('') + '</tr>'
  ).join('');

  // â”€â”€ Pagination â”€â”€
  const pag = document.getElementById('t-pag');
  pag.innerHTML = '';

  const mkBtn = (label, page, disabled=false, active=false) => {
    const b = document.createElement('button');
    b.className = 'page-btn' + (active?' active':'');
    b.textContent = label; b.disabled = disabled;
    b.addEventListener('click', () => { currentPage = page; renderTable(); });
    return b;
  };

  pag.appendChild(mkBtn('Â«', 1,            currentPage===1));
  pag.appendChild(mkBtn('â€¹', currentPage-1, currentPage===1));

  const range = 2;
  for (let p = Math.max(1,currentPage-range); p <= Math.min(pages,currentPage+range); p++) {
    pag.appendChild(mkBtn(p, p, false, p===currentPage));
  }

  pag.appendChild(mkBtn('â€º', currentPage+1, currentPage===pages));
  pag.appendChild(mkBtn('Â»', pages,          currentPage===pages));
}
</script>
</body>
</html>
